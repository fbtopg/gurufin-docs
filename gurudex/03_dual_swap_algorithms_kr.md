# 듀얼 스왑 알고리즘

GuruDex는 소매 사용자와 기관 참여자 모두에게 최적의 서비스를 제공하도록 설계된 정교한 듀얼 스왑 알고리즘 아키텍처를 사용합니다. 이 하이브리드 접근 방식은 소매 거래를 위한 자동화된 시장 조성자(AMM) 모델의 강점과 기관을 위한 실시간 오라클 기반 가격 책정을 활용하여 효율적이고 슬리피지가 적은 스왑을 보장합니다.

***

## 소매 스왑: AMM (Automated Market Maker)

소매 스왑은 Uniswap v3의 집중된 유동성 모델에서 영감을 받은 AMM 알고리즘을 기반으로 합니다. 이 모델은 소규모의 빈번한 거래에 최적화되어 있습니다.

### 수학적 모델

핵심은 상수 곱 공식입니다:

\[ x \times y = k \]

여기서 \(x\)와 \(y\)는 각각 기본 스테이블코인과 견적 스테이블코인의 준비금이며, \(k\)는 상수입니다. 스왑이 발생하면, 풀에 추가된 토큰의 양과 제거된 토큰의 양이 \(k\)를 일정하게 유지하도록 조정됩니다.

**출력 금액 계산:**

수수료를 고려한 후의 출력 금액(\(\Delta y\))은 다음과 같이 계산됩니다:

\[ \Delta y = \frac{y \times \Delta x_{fee}} {x + \Delta x_{fee}} \]

여기서:
* \(\Delta x_{fee}\) = 입력 금액(\(\Delta x\))에서 동적 수수료를 뺀 값입니다.
* \(x\)와 \(y\)는 현재 풀의 준비금입니다.

**동적 수수료 모델:**

수수료는 풀의 불균형에 따라 동적으로 조정되어 재조정을 장려합니다. 이상적인 1:1 준비금 비율에서 벗어나는 1%마다 수수료가 1%씩 증가합니다.

\[ Fee_{dynamic} = Fee_{base} + (\frac{|x - y|}{x + y} \times 100) \% \]

### 실행 흐름

| 단계 | 작업 | 설명 |
|---|---|---|
| 1 | **스왑 시작** | 사용자가 DApp을 통해 스왑을 요청합니다. `swap(isBaseToQuote, amountIn, minAmountOut)` 함수를 호출합니다. |
| 2 | **사용자 확인** | 시스템이 사용자의 소매 상태를 확인하고 비율 제한을 검사합니다. InstitutionalRegistry를 통해 사용자 유형을 확인합니다. |
| 3 | **동적 수수료 계산** | `calculateDynamicFee()`를 호출하여 현재 풀 불균형에 따라 수수료를 결정합니다. 풀의 자산 비율이 1:1에서 벗어날수록 수수료가 증가합니다. |
| 4 | **출력 계산 (AMM)** | AMM 공식 \(x \times y = k\)를 사용하여 수수료 차감 후의 출력 금액을 계산합니다. \(\Delta y = \frac{y \times \Delta x_{fee}}{x + \Delta x_{fee}}\) |
| 5 | **슬리피지 확인** | `amountOut >= minAmountOut`인지 확인하여 사용자를 과도한 가격 영향으로부터 보호합니다. 조건이 충족되지 않으면 거래가 취소됩니다. |
| 6 | **상태 업데이트** | 풀의 준비금을 업데이트하고 수수료를 누적합니다. 풀의 불균형 상태도 함께 갱신됩니다. |
| 7 | **자금 이체** | 계산된 출력 금액을 사용자에게 전송합니다. 수수료는 FeeDistributor로 전송됩니다. |
| 8 | **이벤트 발생** | 거래 완료 이벤트를 발생시켜 투명성을 보장합니다. |

### 실행 예시: 소매 사용자 스왑

**시나리오**: 사용자가 1,000 USGX를 KRGX로 교환하고자 합니다.

1. **초기 상태**: 
   - USGX 풀 준비금: 100,000
   - KRGX 풀 준비금: 130,000,000 (USD/KRW 환율 1:1,300 가정)
   - 풀 불균형: 약 0% (균형 잡힌 상태)
   
2. **동적 수수료 계산**:
   - 기본 수수료: 0.3%
   - 불균형 조정: 0% (균형 잡힌 풀)
   - 최종 수수료: 0.3%

3. **수수료 차감**: 1,000 USGX × 0.997 = 997 USGX

4. **출력 계산**: 
   - \(\Delta y = \frac{130,000,000 \times 997}{100,000 + 997} \approx 1,286,710\) KRGX

5. **최종 결과**: 사용자는 1,000 USGX를 입금하고 약 1,286,710 KRGX를 받습니다.

***

## 기관 스왑: 오라클 기반 가격 책정

기관 스왑은 실시간 가격 오라클 네트워크를 활용하여 대규모 거래에서 최소한의 슬리피지를 보장하는 RFQ(Request-for-Quote) 스타일의 실행을 지원합니다.

### 수학적 모델

기관 스왑의 모델은 간단하며, 오라클에서 제공하는 검증된 실시간 환율을 직접 적용합니다.

**출력 금액 계산:**

\[ amountOut = amountIn \times Price_{oracle} \times (1 - Fee_{inst}) \]

여기서:
* \(amountIn\) = 입력 금액입니다.
* \(Price_{oracle}\) = 오라클에서 제공하고 검증된 실시간 환율입니다.
* \(Fee_{inst}\) = 기관에 대해 구성된 고정 수수료율(예: 0.1%)입니다.

**가격 검증 모델:**

오라클 가격은 제출 시 온체인에서 검증되어야 합니다.

\[ |\frac{Price_{oracle} - Price_{stored}}{Price_{stored}}| \leq Deviation_{max} \]

또한, 데이터의 타임스탬프는 최대 허용 기간(예: 5분)보다 최신이어야 합니다.

### 실행 흐름

| 단계 | 작업 | 설명 |
|---|---|---|
| 1 | **사전 거래 확인 (오프체인)** | 서버 측에서 기관의 KYC/AML 상태, 권한 및 한도를 미리 확인합니다. 이 단계는 온체인 거래 전에 오프체인에서 수행됩니다. |
| 2 | **실시간 환율 업데이트** | 서버는 외부 API로부터 받은 최신 환율을 `PriceOracle` 컨트랙트에 업데이트합니다 (`updatePrice` 함수). |
| 3 | **스왑 시작** | 기관이 서명된 거래 요청과 함께 `swap(amountIn, oraclePrice)` 함수를 호출합니다. |
| 4 | **상태 확인** | 시스템이 `InstitutionalRegistry`에서 기관의 활성 상태를 확인합니다. 상태가 `ACTIVE`가 아니면 거래가 거부됩니다. |
| 5 | **오라클 가격 검증 (3중 검증)** | `PriceOracle` 계약이 제출된 `oraclePrice`에 대해 다음을 검증합니다:<br/>- **시간 검증**: 데이터가 최대 허용 기간(예: 5분) 이내인지<br/>- **편차 검증**: 이전 가격과의 차이가 허용 범위 내인지<br/>- **신뢰도 검증**: 오라클 데이터의 신뢰도가 임계값 이상인지 |
| 6 | **한도 확인** | 기관별 거래당 한도 및 일일 누적 거래량 한도를 확인합니다. 한도를 초과하면 거래가 거부됩니다. |
| 7 | **출력 계산 (오라클 기반)** | 검증된 오라클 가격과 기관별 맞춤형 고정 수수료를 사용하여 출력 금액을 계산합니다:<br/>\(amountOut = amountIn \times Price_{oracle} \times (1 - Fee_{inst})\) |
| 8 | **상태 업데이트** | 풀의 준비금을 업데이트하고 기관의 일일 거래량을 기록합니다. 규정 준수를 위한 거래 로그도 저장됩니다. |
| 9 | **자금 이체** | 계산된 출력 금액을 기관에 전송합니다. 수수료는 FeeDistributor로 전송됩니다. |
| 10 | **이벤트 발생** | 기관 거래 완료 이벤트를 발생시켜 감사 추적을 제공합니다. |

### 실행 예시: 기관 사용자 스왑

**시나리오**: 은행이 100,000 USGX를 KRGX로 대규모 교환하고자 합니다.

1. **사전 확인 (오프체인)**:
   - KYC/AML 상태: ACTIVE
   - 일일 거래 한도: 1,000,000 USGX
   - 현재 일일 사용량: 200,000 USGX
   - 맞춤형 수수료율: 0.1%

2. **오라클 가격 업데이트**:
   - 외부 API 환율: 1 USD = 1,300 KRW
   - 오라클에 업데이트된 시간: 2025-11-07 14:30:00
   - 신뢰도: 99.5%

3. **가격 검증 (3중 검증)**:
   - ✅ 시간: 현재 시간과 2분 차이 (5분 이내)
   - ✅ 편차: 이전 가격(1,299 KRW) 대비 0.08% 차이 (1% 허용 범위 내)
   - ✅ 신뢰도: 99.5% (95% 임계값 초과)

4. **한도 확인**:
   - 거래 금액: 100,000 USGX
   - 거래 후 일일 사용량: 300,000 USGX (한도 내)
   - ✅ 승인

5. **출력 계산**:
   - \(amountOut = 100,000 \times 1,300 \times (1 - 0.001) = 129,870,000\) KRGX

6. **최종 결과**: 
   - 기관은 100,000 USGX를 입금하고 129,870,000 KRGX를 받습니다.
   - 수수료: 130,000 KRGX (0.1%)
   - 슬리피지: 거의 0% (오라클 가격 고정)

***

## 비교 분석

| 기능 | 소매 AMM | 기관 오라클 가격 책정 |
|---|---|---|
| **가격 결정** | 온체인 유동성 및 상수 곱 공식 | 외부 실시간 오라클 가격 피드 |
| **수학적 복잡성** | 높음 (동적 곡선 및 수수료) | 낮음 (직접 곱셈) |
| **슬리피지** | 가변적 (거래 규모에 따라 다름) | 최소화 (가격 고정) |
| **실행 신뢰성** | 높음 (온체인 데이터에만 의존) | 높음 (오라클 검증 통과 시) |
| **수수료 모델** | 동적 (풀 균형에 따라 변동) | 고정/맞춤형 (일반적으로 낮음) |

***

## 알고리즘 선택 로직

FXSwapMaster 계약은 호출자의 사용자 유형에 따라 사용할 알고리즘을 결정합니다:

```solidity
function determineSwapPath(address user) internal view returns (SwapPath) {
    UserType userType = institutionalRegistry.getUserType(user);
    
    if (userType == UserType.INSTITUTIONAL) {
        return SwapPath.ORACLE_BASED;
    } else {
        return SwapPath.AMM;
    }
}
```

이 듀얼 알고리즘 아키텍처는 각 사용자 유형이 특정 요구 사항에 맞춤화된 최적화된 거래 경험을 받으면서 최대 자본 효율성을 위해 통합 유동성 풀을 유지하도록 보장합니다.

***

## 결론

GuruDex 내의 듀얼 스왑 알고리즘 설계는 탈중앙화 무허가 거래와 기관급 실행 간의 정교한 균형을 나타냅니다. 단일 하이브리드 풀 내에서 소매 사용자를 위한 AMM 기반 스왑과 기관을 위한 오라클 기반 가격 책정을 제공함으로써 GuruDex는 최적의 유동성 활용, 최소화된 슬리피지 및 글로벌 FX 거래 플랫폼을 위한 규정 준수 준비 인프라를 제공하도록 설계되었습니다.

구현 세부 사항 및 스마트 계약 인터페이스는 [Architecture](01_architecture.md) 및 [Hybrid Pools](02_hybrid_pools.md) 문서를 참조하십시오.

